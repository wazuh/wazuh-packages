
name: Bump version - wazuh-packages
on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Base branch to create the PR'
        required: true
      version:
        description: 'Version to bump to'
        required: true
      revision:
        description: 'Revision to bump to. Defalut: 1'
        required: false
      date:
        description: 'Date to bump to. Default: today'
        required: false

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - uses: peterjgrainger/action-create-branch@v2.2.0
        with:
          branch: bump-version-${{ github.event.inputs.version }}
          sha: ${{ github.head_ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: bump-version-${{ github.event.inputs.version }}
          
      - name: Set execution parameters
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "VERSION=\"-v ${{ github.event.inputs.version }}\"" >> $GITHUB_ENV 
          fi
          if [ -n "${{ github.event.inputs.revision }}" ]; then
            echo "REVISION=\"-r ${{ github.event.inputs.revision }}\"" >> $GITHUB_ENV 
          fi
          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "DATE=\"-d ${{ github.event.inputs.date }}\"" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Bump version
        run: |
          python3 ./bump_version.py ${{ env.VERSION }} ${{ env.REVISION }} ${{ env.DATE }}
        shell: bash

      - name: "Commit changes and push"
        run: |
            git config --global user.name "wazuhci"
            git config --global user.email "wazuhci@wazuh.com"
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
            git add .
            git commit -m "Bump version to ${{ github.event.inputs.version }}"
            git push origin bump-version-${{ github.event.inputs.version }}
        shell: bash

      - name: "Create pull request"
        run: |
            gh pr create -B "${{ env.BASE_BRANCH }}" -H "bump-version-${{ github.event.inputs.version }}" \
            --title 'Bump branch ${{ env.BASE_BRANCH }} to version ${{ github.event.inputs.version }}' \
            --body 'Pull request to bump branch ${{ github.head_ref }} to version ${{ github.event.inputs.version }}'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
